<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Paper Store â€” Enhanced E-commerce</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        /* Light and Dark Theme Variables */
        :root {
            --accent: #0f766e;
            --accent-dark: #0a524c;
            --light-bg: #f8fafc;
            --light-surface: #ffffff;
            --light-text: #0f172a;
            --light-muted-text: #6b7280;
            --light-border: #e6eef2;
            --dark-bg: #111827;
            --dark-surface: #1f2937;
            --dark-text: #f9fafb;
            --dark-muted-text: #9ca3af;
            --dark-border: #374151;
            --highlight: #ffedd5;
            --error: #ef4444;
            --success: #10b981;
            --warning: #f59e0b; /* For star ratings and warnings */
        }
        /* Default to Light Theme */
        body {
            --bg-color: var(--light-bg);
            --surface-color: var(--light-surface);
            --text-color: var(--light-text);
            --muted-text-color: var(--light-muted-text);
            --border-color: var(--light-border);
        }
        /* Dark Theme Overrides */
        body.dark-mode {
            --bg-color: var(--dark-bg);
            --surface-color: var(--dark-surface);
            --text-color: var(--dark-text);
            --muted-text-color: var(--dark-muted-text);
            --border-color: var(--dark-border);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Header */
        header {
            background: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 50;
            margin: 0 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .brand h1 {
            font-size: 1.25rem;
            font-weight: 600;
            transition: color 0.3s ease;
            color: var(--text-color);
        }
        .brand h1:hover { color: var(--accent); }
        .controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        button, .btn {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: var(--accent-dark);
            transform: translateY(-2px);
        }
        .btn.secondary {
            background: var(--surface-color);
            color: var(--accent);
            border: 1px solid var(--border-color);
        }
        .btn.secondary:hover { background: var(--highlight); }
        button:disabled, .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: var(--muted-text-color);
        }
        main {
            padding: 2rem;
            max-width: 1280px;
            margin: 0 auto;
        }
        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(0,0,0,0.3)), url('https://images.pexels.com/photos/701016/pexels-photo-701016.jpeg');
            background-size: cover;
            background-position: center;
            color: #fff;
            padding: 8rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            margin: 1.5rem;
            border-radius: 0.75rem;
            animation: subtleZoom 15s infinite alternate ease-in-out, hueRotate 25s infinite linear;
        }
        .hero-content {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        .hero h1 {
            font-size: 3.5rem;
            margin: 0 0 1.5rem;
            animation: fadeInDown 1s ease-out, pulse 3s infinite;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .hero p {
            font-size: 1.75rem;
            margin: 0 0 2rem;
            animation: fadeInUp 1s ease-out 0.3s;
            animation-fill-mode: both;
        }
        .hero .btn {
            background: linear-gradient(45deg, #fff, #f1f5f9);
            color: var(--accent);
            padding: 1rem 2rem;
            font-size: 1.1rem;
            animation: fadeInUp 1s ease-out 0.6s, bounce 2.5s infinite;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .hero .btn:hover { transform: scale(1.05); }
        /* Animations */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes subtleZoom {
            0% { background-size: 100%; }
            100% { background-size: 115%; }
        }
        @keyframes hueRotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-12px); }
            60% { transform: translateY(-6px); }
        }
        @keyframes cardHover {
            0% { transform: translateY(0); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
            100% { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes popUp {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Filters and Search */
        .filters {
            display: flex;
            gap: 1.5rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
            align-items: center;
        }
        .search-bar {
            flex: 1;
            min-width: 200px;
            position: relative; /* For suggestions dropdown */
        }
        .search-bar input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            transition: border-color 0.3s ease, background-color 0.3s ease;
            background-color: var(--surface-color);
            color: var(--text-color);
        }
        .search-bar input:focus {
            border-color: var(--accent);
            outline: none;
        }
        /* NEW: Search Suggestions */
        #searchSuggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            z-index: 40;
            max-height: 300px;
            overflow-y: auto;
        }
        .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .suggestion-item:hover {
            background: var(--highlight);
        }
        .suggestion-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 0.25rem;
        }
        .suggestion-item .title {
            font-weight: 600;
        }
        .suggestion-item .price {
            margin-left: auto;
            color: var(--accent);
        }

        .category-filter select, .sort-filter select {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            cursor: pointer;
            background: var(--surface-color);
            color: var(--text-color);
        }
        /* Product Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }
        /* UPDATED: 3 columns for desktop */
        @media (min-width: 1024px) {
            .grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        .card {
            background: var(--surface-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .card:hover {
            animation: cardHover 0.3s forwards;
        }
        .card .sold-out-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: var(--error);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 2;
        }
        .card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
            transition: transform 0.3s ease;
        }
        .card:hover img { transform: scale(1.05); }
        .card h3 {
            margin: 0.75rem 0 0.25rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
        }
        .price {
            font-weight: 700;
            color: var(--accent);
            margin: 0.5rem 0;
        }
        .preview-container {
            position: relative;
            height: 140px;
            overflow: hidden;
            margin: 0.75rem 0;
            border-radius: 0.5rem;
        }
        .preview-overlay {
            background: linear-gradient(rgba(255,255,255,0), rgba(255,255,255,0.95));
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 60%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding: 0.75rem;
            gap: 0.5rem;
        }
        body.dark-mode .preview-overlay {
            background: linear-gradient(rgba(31,41,55,0), rgba(31,41,55,0.95));
        }
        .preview-overlay .btn {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            transition: transform 0.2s ease;
        }
        .preview-overlay .btn:hover { transform: scale(1.1); }
        .rating {
            display: flex;
            gap: 0.25rem;
            margin: 0.5rem 0;
            color: var(--warning);
        }
        .wishlist-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #e11d48;
            cursor: pointer;
            transition: transform 0.2s ease;
            z-index: 2;
        }
        .wishlist-btn:hover { transform: scale(1.2); }
        .wishlist-btn.active { color: #be123c; }
        /* Cart Drawer */
        .cart-btn, .wishlist-btn-header { position: relative; }
        .cart-count, .wishlist-count {
            position: absolute;
            top: -8px;
            right: -10px;
            background: var(--error);
            color: #fff;
            border-radius: 999px;
            padding: 3px 8px;
            font-size: 0.8rem;
        }
        .drawer {
            position: fixed;
            right: 2rem;
            top: 90px;
            width: 380px;
            max-width: calc(100% - 4rem);
            background: var(--surface-color);
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(2,6,23,0.15);
            padding: 1.5rem;
            display: none;
            z-index: 60;
            animation: slideInRight 0.3s ease-out;
            margin: 1rem;
            transition: background-color 0.3s ease;
        }
        .drawer.open { display: block; }
        .close-drawer-btn {
            position: absolute;
            top: 0.75rem;
            right: 1rem;
            font-size: 1.75rem;
            cursor: pointer;
            color: var(--muted-text-color);
            transition: color 0.2s ease;
        }
        .close-drawer-btn:hover { color: var(--error); }
        .cart-line {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px dashed var(--border-color);
            transition: background 0.2s ease;
        }
        .cart-line:hover { background: var(--highlight); }
        .cart-line img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .cart-meta { flex: 1; }
        .qty {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.75rem;
        }
        .small { font-size: 0.9rem; color: var(--muted-text-color); }
        /* Product Popup and other Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background: var(--surface-color);
            border-radius: 0.75rem;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            position: relative;
            animation: popUp 0.3s ease-out;
            margin: 1rem;
            color: var(--text-color);
            max-height: 90vh;
            overflow-y: auto;
        }
        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted-text-color);
            transition: color 0.2s ease;
        }
        .close-btn:hover { color: var(--error); }
        .modal-content img {
            width: 100%;
            height: 240px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        /* Checkout View */
        .checkout {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: 0.75rem;
            margin: 1.5rem 0;
            border: 1px solid var(--border-color);
            animation: fadeInUp 0.5s ease-out;
        }
        .row {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            margin: 1rem 0;
        }
        .col {
            flex: 1;
            min-width: 280px;
        }
        label {
            display: block;
            margin: 0.75rem 0;
            font-weight: 600;
        }
        input[type=text], input[type=email], select, textarea {
            width: 100%;
            padding: 0.8rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background-color: var(--surface-color);
            color: var(--text-color);
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            outline: none;
        }
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            margin: 2rem 0;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--surface-color);
        }
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--success);
            color: #fff;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            display: none;
            z-index: 200;
            margin: 1rem;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
        }
        .toast.error { background: var(--error); }
        .toast.show { display: block; }
        /* Loading Animation */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 150;
        }
        body.dark-mode .loading {
            background: rgba(17, 24, 39, 0.8);
        }
        .loading.active { display: flex; }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        /* Recently Viewed Section */
        .recently-viewed {
            margin: 2rem 0;
        }
        .recently-viewed .grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        footer {
            padding: 2rem;
            text-align: center;
            color: var(--muted-text-color);
            background: var(--surface-color);
            border-top: 1px solid var(--border-color);
            margin-top: 2rem;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        /* NEW: Back to Top Button */
        #backToTopBtn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            cursor: pointer;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(20px);
        }
        #backToTopBtn.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        /* NEW: Review System Styles */
        .reviews-section {
            margin-top: 2rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
        }
        .review {
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .review-rating .fa-star { color: var(--warning); }
        .review-author { font-weight: 600; }
        .review-comment { margin-top: 0.5rem; color: var(--muted-text-color); }
        .star-rating-input {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            gap: 0.25rem;
        }
        .star-rating-input input { display: none; }
        .star-rating-input label {
            font-size: 2rem;
            color: var(--muted-text-color);
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .star-rating-input input:checked ~ label,
        .star-rating-input label:hover,
        .star-rating-input label:hover ~ label {
            color: var(--warning);
        }
        /* NEW: Coupon Input Styles */
        .coupon-section { margin-top: 1rem; display: flex; gap: 0.5rem; }
        .coupon-section input { flex: 1; }
        .discount-line { color: var(--success); font-weight: 600; display: flex; justify-content: space-between; }
        
        /* NEW: Order History Styles */
        #orderHistoryList .order-item {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        #orderHistoryList .order-header {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
                margin: 0 0.5rem;
            }
            main { padding: 1rem; }
            .hero {
                padding: 4rem 1rem;
                margin: 1rem 0.5rem;
            }
            .hero h1 { font-size: 2.5rem; }
            .hero p { font-size: 1.25rem; }
            .hero .btn { padding: 0.75rem 1.5rem; font-size: 1rem; }
            .grid { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
            .card img { height: 160px; }
            .preview-container { height: 120px; }
            .drawer {
                left: 1rem;
                right: 1rem;
                top: 160px;
                width: calc(100% - 2rem);
                margin: 0.5rem;
            }
            .modal-content {
                width: calc(100% - 2rem);
                padding: 1.5rem;
                margin: 0.5rem;
            }
            .modal-content img { height: 200px; }
            .filters { gap: 1rem; margin: 1rem 0; }
            .row { gap: 1rem; }
            .col { min-width: 100%; }
            .checkout { padding: 1.5rem; }
            .recently-viewed .grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
        }
        @media (max-width: 480px) {
            header { padding: 0.75rem; margin: 0 0.25rem; }
            main { padding: 0.75rem; }
            .hero {
                padding: 3rem 0.75rem;
                margin: 0.75rem 0.25rem;
            }
            .hero h1 { font-size: 1.75rem; }
            .hero p { font-size: 1rem; }
            .grid { grid-template-columns: 1fr; gap: 0.75rem; }
            .card { padding: 1rem; }
            .card img { height: 140px; }
            .preview-container { height: 100px; }
            .drawer { padding: 1rem; }
            .modal-content { padding: 1rem; }
            .modal-content img { height: 160px; }
            .toast { bottom: 1rem; right: 1rem; padding: 0.75rem 1rem; margin: 0.5rem; }
            .recently-viewed .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <div class="brand">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="24" height="24" rx="6" fill="var(--accent)"/>
                <path d="M7 8h10v2H7zM7 12h10v2H7z" fill="white"/>
            </svg>
            <h1>Paper Store</h1>
        </div>
        <div class="controls">
            <button class="btn secondary" id="openOrders" aria-label="View My Orders"><i class="fas fa-receipt"></i> My Orders</button>
            <button class="btn secondary wishlist-btn-header" id="openWishlist" aria-label="View Wishlist"><i class="fas fa-heart"></i> Wishlist <span id="wishlistCount" class="wishlist-count" style="display:none;">0</span></button>
            <button class="btn secondary cart-btn" id="openCart" aria-label="View Cart"><i class="fas fa-shopping-cart"></i> Cart <span id="cartCount" class="cart-count" style="display:none">0</span></button>
            <button class="btn secondary" id="themeToggle" title="Toggle dark/light theme" aria-label="Toggle Theme"><i class="fas fa-moon"></i></button>
        </div>
    </header>
    <main>
        <section class="hero">
            <div class="hero-content">
                <h1>Discover Premium Digital Papers & Templates</h1>
                <p>Explore our extensive collection of high-quality downloadable documents, templates, and designs crafted for your creative needs.</p>
                <button class="btn" id="shopNow">Shop Now</button>
            </div>
        </section>
        <section class="filters">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search products..." autocomplete="off" aria-label="Search products">
                <div id="searchSuggestions" style="display: none;"></div>
            </div>
            <div class="category-filter">
                <select id="categoryFilter" aria-label="Filter by category">
                    <option value="all">All Categories</option>
                    <option value="paper">Paper</option>
                    <option value="notebooks">Notebooks</option>
                    <option value="craft">Craft</option>
                    <option value="office">Office</option>
                </select>
            </div>
            <div class="sort-filter">
                <select id="sortFilter" aria-label="Sort products">
                    <option value="default">Sort: Default</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="rating">Rating: High to Low</option>
                </select>
            </div>
        </section>
        <section id="mainShopView">
            <h2 style="margin:0 0 1.5rem">Our Products</h2>
            <div class="grid" id="productGrid"></div>
            <div class="pagination" id="paginationControls">
                <button id="prevPage" class="btn secondary">Previous</button>
                <span id="pageInfo" aria-live="polite">1 / 3</span>
                <button id="nextPage" class="btn secondary">Next</button>
            </div>
        </section>
        <section class="recently-viewed" id="recentlyViewed" style="display:none">
            <h2 style="margin:0 0 1.5rem">Recently Viewed</h2>
            <div class="grid" id="recentlyViewedGrid"></div>
        </section>

        <section class="checkout" id="checkoutSection" style="display:none"></section>
        <section class="checkout" id="orderConfirmation" style="display:none"></section>

    </main>

    <div class="modal-overlay" id="productPopup" role="dialog" aria-modal="true" aria-labelledby="popupTitle">
        <div class="modal-content">
            <button class="close-btn" id="closePopup" aria-label="Close product details">&times;</button>
            <img id="popupImage" src="" alt="">
            <h2 id="popupTitle"></h2>
            <p id="popupDesc" class="small"></p>
            <div class="price" id="popupPrice"></div>
            <div class="rating" id="popupRating"></div>
            <div style="margin-top:1.5rem;display:flex;gap:0.75rem">
                <button class="btn" id="popupAddToCart"><i class="fas fa-cart-plus"></i> Add to Cart</button>
                <button class="btn secondary" id="popupBuyNow">Buy Now</button>
                <button class="btn secondary" id="popupAddToWishlist" aria-label="Add to wishlist"><i class="fas fa-heart"></i></button>
            </div>
            <div class="reviews-section" id="popupReviews">
                <h3>Customer Reviews</h3>
                <div id="popupReviewsList">No reviews yet.</div>
            </div>
        </div>
    </div>
    
    <div class="drawer" id="cartDrawer" aria-hidden="true">
        <button class="close-drawer-btn" data-close-drawer="cartDrawer" aria-label="Close cart">&times;</button>
        <h3 style="margin:0 0 1rem">Your Cart</h3>
        <div id="cartList" aria-live="polite"></div>
        <div id="couponSection" class="coupon-section">
            <input type="text" id="couponInput" placeholder="Enter coupon code">
            <button class="btn secondary" id="applyCouponBtn">Apply</button>
        </div>
        <div style="margin-top:1.5rem">
             <div style="display:flex;justify-content:space-between;align-items:center;">
                <div class="small">Subtotal</div>
                <div id="subtotal" style="font-weight:700">$0.00</div>
            </div>
            <div id="discountLine" class="discount-line" style="display: none;"></div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:0.5rem; font-size: 1.2rem; font-weight: 700;">
                <div>Total</div>
                <div id="cartTotal"></div>
            </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1.5rem">
            <button class="btn secondary" id="clearCart">Clear</button>
            <button class="btn" id="checkoutBtn">Checkout</button>
        </div>
    </div>

    <div class="drawer" id="wishlistDrawer" aria-hidden="true">
        <button class="close-drawer-btn" data-close-drawer="wishlistDrawer" aria-label="Close wishlist">&times;</button>
        <h3 style="margin:0 0 1rem">Your Wishlist</h3>
        <div style="margin-bottom:1rem; display: flex; gap: 0.5rem;">
            <button class="btn secondary" id="clearWishlist">Clear Wishlist</button>
            <button class="btn" id="wishlistAddAllToCart">Add All to Cart</button>
        </div>
        <div id="wishlistList"></div>
    </div>

    <div class="modal-overlay" id="orderHistoryModal" role="dialog" aria-modal="true" aria-labelledby="orderHistoryTitle">
        <div class="modal-content">
            <button class="close-btn" data-close-modal="orderHistoryModal" aria-label="Close order history">&times;</button>
            <h2 id="orderHistoryTitle">My Order History</h2>
            <div id="orderHistoryList"></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="reviewModal" role="dialog" aria-modal="true" aria-labelledby="reviewModalTitle">
        <div class="modal-content">
            <button class="close-btn" data-close-modal="reviewModal" aria-label="Close review form">&times;</button>
            <h2 id="reviewModalTitle">Leave a Review</h2>
            <form id="reviewForm">
                <input type="hidden" id="reviewProductId">
                <div>
                    <label>Rating</label>
                    <div class="star-rating-input">
                        <input type="radio" id="star5" name="rating" value="5"><label for="star5" title="5 stars">â˜…</label>
                        <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 stars">â˜…</label>
                        <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 stars">â˜…</label>
                        <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 stars">â˜…</label>
                        <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 star">â˜…</label>
                    </div>
                </div>
                <div>
                    <label for="reviewComment">Comment</label>
                    <textarea id="reviewComment" rows="4" placeholder="Share your thoughts..."></textarea>
                </div>
                 <div style="margin-top:1.5rem;display:flex;gap:0.75rem;">
                    <button type="submit" class="btn">Submit Review</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast" id="toast" role="alert"></div>
    <div class="loading" id="loading" role="status" aria-live="polite">
        <div class="spinner"></div>
    </div>
    <footer>
        <small>Demo store â€” payments handled client-side. Not PCI compliant. For production, use a secure server and payment processing.
        Downloads are simulated.</small>
    </footer>
    <button id="backToTopBtn" title="Back to Top"><i class="fas fa-arrow-up"></i></button>
    
    <script src="https://www.paypal.com/sdk/js?client-id=REPLACE_WITH_CLIENT_ID&currency=USD" data-sdk-integration-source="button-factory"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {

    //======================================================================
    // CONFIGURATION & INITIAL DATA
    //======================================================================
    const CONFIG = {
        PRODUCTS_PER_PAGE: 9,
        RECENTLY_VIEWED_COUNT: 3,
        PAYPAL_CLIENT_ID: 'REPLACE_WITH_CLIENT_ID', // IMPORTANT: Replace for production
        STORAGE_KEYS: {
            CART: 'paper_store_cart_v2',
            PURCHASES: 'paper_store_purchases_v2',
            WISHLIST: 'paper_store_wishlist_v2',
            RECENTLY_VIEWED: 'paper_store_recently_viewed_v2',
            THEME: 'paper_store_theme_v2',
            REVIEWS: 'paper_store_reviews_v1',
            ORDERS: 'paper_store_orders_v1',
            COUPON: 'paper_store_coupon_v1',
        },
        COUPONS: {
            'SAVE10': { type: 'percent', value: 0.10 }, // 10% off
            '20OFF': { type: 'fixed', value: 20 }, // $20 off
        }
    };
    
    let ALL_PRODUCTS = [
        {id:'a4-ream-80',title:'A4 Paper Ream 80gsm (500 sheets)',price:7.50,desc:'Smooth printing paper, multipurpose',category:'paper',img:'https://images.pexels.com/photos/245240/pexels-photo-245240.jpeg',downloadLink:'https://example.com/downloads/a4-ream-80.pdf',rating:4.5, stock: 50},
        {id:'a3-ream-120',title:'A3 Paper 120gsm (250 sheets)',price:12.00,desc:'Heavier paper for presentations',category:'paper',img:'https://images.pexels.com/photos/796602/pexels-photo-796602.jpeg',downloadLink:'https://example.com/downloads/a3-ream-120.pdf',rating:4.7, stock: 30},
        {id:'notebook-ruled',title:'Ruled Notebooks (pack of 5)',price:9.00,desc:'College-ruled notebooks for notes',category:'notebooks',img:'https://images.unsplash.com/photo-1515378791036-0648a3ef77b2',downloadLink:'https://example.com/downloads/notebook-ruled.zip',rating:4.2, stock: 100},
        {id:'cardstock-100',title:'Cardstock 100gsm (100 sheets)',price:15.00,desc:'Perfect for cards and craft',category:'craft',img:'https://images.unsplash.com/photo-1496318447583-f524534e9ce1',downloadLink:'https://example.com/downloads/cardstock-100.zip',rating:4.8, stock: 40},
        {id:'colored-paper',title:'Colored Paper Assortment (200 sheets)',price:10.00,desc:'Vibrant colors for crafts',category:'craft',img:'https://images.pexels.com/photos/245240/pexels-photo-245240.jpeg',downloadLink:'https://example.com/downloads/colored-paper.zip',rating:4.3, stock: 0}, // Example of sold out
        {id:'graph-paper',title:'Graph Paper Pad (50 sheets)',price:5.50,desc:'Ideal for math and drawing',category:'paper',img:'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158',downloadLink:'https://example.com/downloads/graph-paper.pdf',rating:4.4, stock: 60},
        {id:'sketchbook-a5',title:'Sketchbook A5 (100 pages)',price:8.00,desc:'For artists and doodlers',category:'notebooks',img:'https://images.unsplash.com/photo-1509023464722-18d996393ca8',downloadLink:'https://example.com/downloads/sketchbook-a5.pdf',rating:4.6, stock: 75},
        {id:'envelopes-c5',title:'Envelopes C5 (pack of 50)',price:6.00,desc:'White self-seal envelopes',category:'office',img:'https://images.unsplash.com/photo-1496318447583-f524534e9ce1',downloadLink:'https://example.com/downloads/envelopes-c5.zip',rating:4.1, stock: 120},
        {id:'sticky-notes',title:'Sticky Notes (pack of 100)',price:3.00,desc:'Assorted colors for reminders',category:'office',img:'https://images.unsplash.com/photo-1496318447583-f524534e9ce1',downloadLink:'https://example.com/downloads/sticky-notes.zip',rating:4.0, stock: 200},
        {id:'copy-paper-70',title:'Copy Paper Ream 70gsm (500 sheets)',price:6.00,desc:'Everyday printing paper',category:'paper',img:'https://images.pexels.com/photos/245240/pexels-photo-245240.jpeg',downloadLink:'https://example.com/downloads/copy-paper-70.pdf',rating:4.3, stock: 80},
        {id:'photo-paper',title:'Photo Paper Glossy (20 sheets)',price:9.50,desc:'High-quality photo printing',category:'paper',img:'https://images.pexels.com/photos/370474/pexels-photo-370474.jpeg',downloadLink:'https://example.com/downloads/photo-paper.pdf',rating:4.7, stock: 25},
        {id:'kraft-roll',title:'Kraft Paper Roll (10m)',price:4.50,desc:'For wrapping and crafts',category:'craft',img:'https://images.pexels.com/photos/26891689/pexels-photo-26891689.jpeg',downloadLink:'https://example.com/downloads/kraft-roll.zip',rating:4.2, stock: 55},
        {id:'tissue-paper',title:'Tissue Paper (pack of 50)',price:2.50,desc:'Soft and colorful',category:'craft',img:'https://images.pexels.com/photos/370474/pexels-photo-370474.jpeg',downloadLink:'https://example.com/downloads/tissue-paper.zip',rating:4.0, stock: 90},
        {id:'construction-paper',title:'Construction Paper (assorted, 100 sheets)',price:7.00,desc:'For school projects',category:'craft',img:'https://images.unsplash.com/photo-1515378791036-0648a3ef77b2',downloadLink:'https://example.com/downloads/construction-paper.zip',rating:4.4, stock: 15},
        {id:'legal-pad',title:'Legal Pad (pack of 3)',price:5.00,desc:'Yellow ruled pads',category:'notebooks',img:'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158',downloadLink:'https://example.com/downloads/legal-pad.pdf',rating:4.3, stock: 65},
        {id:'index-cards',title:'Index Cards (pack of 100)',price:2.00,desc:'Blank for flashcards',category:'office',img:'https://images.pexels.com/photos/796602/pexels-photo-796602.jpeg',downloadLink:'https://example.com/downloads/index-cards.zip',rating:4.1, stock: 300},
        {id:'binder-refill',title:'Binder Paper Refill (200 sheets)',price:4.00,desc:'3-hole punched',category:'paper',img:'https://images.pexels.com/photos/245240/pexels-photo-245240.jpeg',downloadLink:'https://example.com/downloads/binder-refill.pdf',rating:4.2, stock: 85},
        {id:'watercolor-paper',title:'Watercolor Paper (10 sheets)',price:10.00,desc:'Thick and textured',category:'paper',img:'https://images.unsplash.com/photo-1496318447583-f524534e9ce1',downloadLink:'https://example.com/downloads/watercolor-paper.pdf',rating:4.6, stock: 35},
        {id:'tracing-paper',title:'Tracing Paper (50 sheets)',price:6.50,desc:'Translucent for designs',category:'paper',img:'https://images.unsplash.com/photo-1509023464722-18d996393ca8',downloadLink:'https://example.com/downloads/tracing-paper.pdf',rating:4.5, stock: 45},
        {id:'carbon-paper',title:'Carbon Paper (100 sheets)',price:8.50,desc:'For duplicates',category:'paper',img:'https://images.pexels.com/photos/11391944/pexels-photo-11391944.jpeg',downloadLink:'https://example.com/downloads/carbon-paper.pdf',rating:4.3, stock: 20},
        {id:'parchment-paper',title:'Parchment Paper (roll)',price:3.50,desc:'Baking and cooking use',category:'craft',img:'https://images.unsplash.com/photo-1588195538326-c5b1dc01b80b',downloadLink:'https://example.com/downloads/parchment-paper.zip',rating:4.2, stock: 50},
        {id:'newsprint-paper',title:'Newsprint Paper (500 sheets)',price:12.50,desc:'For sketching and packing',category:'paper',img:'https://images.pexels.com/photos/245240/pexels-photo-245240.jpeg',downloadLink:'https://example.com/downloads/newsprint-paper.pdf',rating:4.4, stock: 10},
        {id:'manila-folders',title:'Manila Folders (pack of 10)',price:4.00,desc:'Letter size folders',category:'office',img:'https://images.pexels.com/photos/796602/pexels-photo-796602.jpeg',downloadLink:'https://example.com/downloads/manila-folders.zip',rating:4.0, stock: 110},
        {id:'file-folders',title:'File Folders (pack of 20)',price:7.00,desc:'Colored tab folders',category:'office',img:'https://images.unsplash.com/photo-1515378791036-0648a3ef77b2',downloadLink:'https://example.com/downloads/file-folders.zip',rating:4.3, stock: 130},
        {id:'postit-flags',title:'Post-it Flags (pack of 50)',price:2.50,desc:'Page markers',category:'office',img:'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158',downloadLink:'https://example.com/downloads/postit-flags.zip',rating:4.1, stock: 150},
        {id:'label-sheets',title:'Label Sheets (A4, 100 sheets)',price:15.00,desc:'Adhesive labels',category:'office',img:'https://images.unsplash.com/photo-1496318447583-f524534e9ce1',downloadLink:'https://example.com/downloads/label-sheets.pdf',rating:4.5, stock: 88},
        {id:'thermal-roll',title:'Thermal Paper Roll (for receipts)',price:5.00,desc:'POS printer compatible',category:'office',img:'https://images.unsplash.com/photo-1509023464722-18d996393ca8',downloadLink:'https://example.com/downloads/thermal-roll.zip',rating:4.2, stock: 99},
        {id:'origami-paper',title:'Origami Paper (assorted, 100 sheets)',price:6.00,desc:'Square colored sheets',category:'craft',img:'https://images.unsplash.com/photo-1586078440766-40f576d318b7',downloadLink:'https://example.com/downloads/origami-paper.zip',rating:4.4, stock: 5},
        {id:'drawing-pad-a3',title:'Drawing Pad A3 (50 sheets)',price:11.00,desc:'For large sketches',category:'notebooks',img:'https://images.pexels.com/photos/159711/books-bookstore-book-reading-159711.jpeg',downloadLink:'https://example.com/downloads/drawing-pad-a3.pdf',rating:4.6, stock: 18},
        {id:'memo-pad',title:'Memo Pad (pack of 5)',price:4.50,desc:'Small notepads',category:'notebooks',img:'https://images.pexels.com/photos/2041540/pexels-photo-2041540.jpeg',downloadLink:'https://example.com/downloads/memo-pad.zip',rating:4.3, stock: 43}
    ];

    //======================================================================
    // STATE MANAGEMENT
    //======================================================================
    const state = {
        cart: {},
        purchases: [],
        wishlist: [],
        recentlyViewed: [],
        reviews: {},
        orders: [],
        appliedCoupon: null,
        products: [], // This will hold the live product data, including updated stock
        currentPage: 0,
        currentCategory: 'all',
        searchQuery: '',
        sortOption: 'default',
    };

    // Safely load from localStorage
    const loadState = () => {
        try {
            state.cart = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.CART) || '{}');
            state.purchases = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.PURCHASES) || '[]');
            state.wishlist = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.WISHLIST) || '[]');
            state.recentlyViewed = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.RECENTLY_VIEWED) || '[]');
            state.reviews = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.REVIEWS) || '{}');
            state.orders = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.ORDERS) || '[]');
            state.appliedCoupon = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.COUPON) || 'null');

            // Initialize product data, preserving original data structure
            state.products = ALL_PRODUCTS.map(p => ({...p})); 
        } catch (e) {
            console.error("Failed to load state from localStorage:", e);
        }
    };

    const saveState = (key, data) => {
        try {
            localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
            console.error(`Error saving ${key}:`, e);
        }
    };
    
    //======================================================================
    // DOM ELEMENTS
    //======================================================================
    const getEl = (id) => document.getElementById(id);
    const $ = {
        productGrid: getEl('productGrid'),
        popup: getEl('productPopup'),
        popupImage: getEl('popupImage'),
        popupTitle: getEl('popupTitle'),
        popupDesc: getEl('popupDesc'),
        popupPrice: getEl('popupPrice'),
        popupRating: getEl('popupRating'),
        popupAddToCart: getEl('popupAddToCart'),
        popupBuyNow: getEl('popupBuyNow'),
        popupAddToWishlist: getEl('popupAddToWishlist'),
        popupReviewsList: getEl('popupReviewsList'),
        toast: getEl('toast'),
        loading: getEl('loading'),
        recentlyViewedSection: getEl('recentlyViewed'),
        recentlyViewedGrid: getEl('recentlyViewedGrid'),
        searchInput: getEl('searchInput'),
        searchSuggestions: getEl('searchSuggestions'),
        backToTopBtn: getEl('backToTopBtn'),
        prevPageBtn: getEl('prevPage'),
        nextPageBtn: getEl('nextPage'),
        pageInfo: getEl('pageInfo'),
        cartDrawer: getEl('cartDrawer'),
        cartList: getEl('cartList'),
        cartCount: getEl('cartCount'),
        subtotal: getEl('subtotal'),
        cartTotal: getEl('cartTotal'),
        wishlistDrawer: getEl('wishlistDrawer'),
        wishlistList: getEl('wishlistList'),
        wishlistCount: getEl('wishlistCount'),
        checkoutSection: getEl('checkoutSection'),
        orderConfirmation: getEl('orderConfirmation'),
        mainShopView: getEl('mainShopView'),
        orderHistoryModal: getEl('orderHistoryModal'),
        reviewModal: getEl('reviewModal'),
        reviewForm: getEl('reviewForm'),
        couponInput: getEl('couponInput'),
        applyCouponBtn: getEl('applyCouponBtn'),
        discountLine: getEl('discountLine'),
    };

    //======================================================================
    // HELPER FUNCTIONS
    //======================================================================
    const formatCurrency = (n) => `$${(n || 0).toFixed(2)}`;

    const showToast = (message, isError = false) => {
        $.toast.textContent = message;
        $.toast.className = `toast ${isError ? 'error' : ''}`;
        $.toast.classList.add('show');
        setTimeout(() => $.toast.classList.remove('show'), 3000);
    };

    const showLoading = (duration = 500) => {
        $.loading.classList.add('active');
        setTimeout(() => $.loading.classList.remove('active'), duration);
    };

    const getProductById = (id) => state.products.find(p => p.id === id);

    //======================================================================
    // UI RENDERING
    //======================================================================

    /**
     * Renders star rating icons based on a numeric rating.
     * @param {number} rating - The rating value.
     * @returns {string} - HTML string of star icons.
     */
    const renderStars = (rating) => {
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5 ? 1 : 0;
        const emptyStars = 5 - fullStars - halfStar;
        let html = '';
        html += '<i class="fas fa-star"></i>'.repeat(fullStars);
        if (halfStar) html += '<i class="fas fa-star-half-alt"></i>';
        html += '<i class="far fa-star"></i>'.repeat(emptyStars);
        return html;
    };

    const getAverageRating = (productId) => {
        const productReviews = state.reviews[productId] || [];
        if (productReviews.length === 0) {
            return getProductById(productId)?.rating || 0; // Fallback to initial rating
        }
        const totalRating = productReviews.reduce((sum, review) => sum + review.rating, 0);
        return totalRating / productReviews.length;
    };

    /**
     * Creates a product card element.
     * @param {object} p - The product object.
     * @returns {HTMLElement} - The card element.
     */
    const createProductCard = (p) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.productId = p.id;

        const isSoldOut = p.stock === 0;
        const avgRating = getAverageRating(p.id);

        card.innerHTML = `
            ${isSoldOut ? '<div class="sold-out-badge">Sold Out</div>' : ''}
            <button class="wishlist-btn ${state.wishlist.includes(p.id) ? 'active' : ''}" data-wishlist="${p.id}" aria-label="Toggle Wishlist">
                <i class="fas fa-heart"></i>
            </button>
            <img src="${p.img}" alt="${p.title}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/EEE/31343C?text=Image+Not+Found';">
            <h3>${p.title}</h3>
            <div class="small">${p.desc}</div>
            <div class="price">${formatCurrency(p.price)}</div>
            <div class="rating" title="Rating: ${avgRating.toFixed(1)}/5">${renderStars(avgRating)}</div>
            <div class="preview-container">
                <img src="${p.img}" alt="${p.title} preview" onerror="this.onerror=null;this.src='https://placehold.co/600x400/EEE/31343C?text=Image+Not+Found';">
                <div class="preview-overlay">
                    ${state.purchases.includes(p.id)
                        ? `<button class="btn" data-download="${p.id}">Download File</button>`
                        : `<button class="btn" data-buy="${p.id}" ${isSoldOut ? 'disabled' : ''}>${isSoldOut ? 'Sold Out' : 'Buy Now'}</button>`
                    }
                    <button class="btn secondary" data-quick-view="${p.id}"><i class="fas fa-eye"></i> View</button>
                </div>
            </div>
        `;
        return card;
    };

    /**
     * Renders products to the main grid with filtering, sorting, and pagination.
     */
    const renderProducts = (page = 0) => {
        showLoading();
        state.currentPage = page;
        $.productGrid.innerHTML = '';
        
        // Apply filters
        let filteredProducts = state.products.filter(p => {
            const matchesCategory = state.currentCategory === 'all' || p.category === state.currentCategory;
            const matchesSearch = !state.searchQuery || 
                p.title.toLowerCase().includes(state.searchQuery) || 
                p.desc.toLowerCase().includes(state.searchQuery);
            return matchesCategory && matchesSearch;
        });

        // Apply sorting
        switch (state.sortOption) {
            case 'price-low': filteredProducts.sort((a, b) => a.price - b.price); break;
            case 'price-high': filteredProducts.sort((a, b) => b.price - a.price); break;
            case 'rating': filteredProducts.sort((a, b) => getAverageRating(b.id) - getAverageRating(a.id)); break;
        }

        const totalPages = Math.ceil(filteredProducts.length / CONFIG.PRODUCTS_PER_PAGE);
        const pageProducts = filteredProducts.slice(page * CONFIG.PRODUCTS_PER_PAGE, (page + 1) * CONFIG.PRODUCTS_PER_PAGE);

        if (pageProducts.length === 0) {
            $.productGrid.innerHTML = `<p>No products found matching your criteria.</p>`;
        } else {
            pageProducts.forEach(p => $.productGrid.appendChild(createProductCard(p)));
        }
        
        updatePaginationUI(totalPages, filteredProducts.length);
    };

    const updatePaginationUI = (totalPages, totalItems) => {
        const controls = getEl('paginationControls');
        if (totalItems <= CONFIG.PRODUCTS_PER_PAGE) {
            controls.style.display = 'none';
        } else {
            controls.style.display = 'flex';
            $.pageInfo.textContent = `${state.currentPage + 1} / ${totalPages > 0 ? totalPages : 1}`;
            $.prevPageBtn.disabled = state.currentPage === 0;
            $.nextPageBtn.disabled = state.currentPage >= totalPages - 1;
        }
    };
    
    const updateRecentlyViewedUI = () => {
        if (state.recentlyViewed.length === 0) {
            $.recentlyViewedSection.style.display = 'none';
            return;
        }
        $.recentlyViewedSection.style.display = 'block';
        $.recentlyViewedGrid.innerHTML = '';
        state.recentlyViewed.forEach(id => {
            const p = getProductById(id);
            if (p) {
                $.recentlyViewedGrid.appendChild(createProductCard(p));
            }
        });
    };
    
    //======================================================================
    // CORE LOGIC (Cart, Wishlist, etc.)
    //======================================================================
    
    //--------------------- Cart Logic ---------------------
    const addToCart = (productId, quantity = 1) => {
        const p = getProductById(productId);
        if (!p) return;
        const currentQtyInCart = state.cart[productId] || 0;
        const availableStock = p.stock - currentQtyInCart;

        if (quantity > availableStock) {
            showToast(`Only ${availableStock} more available in stock.`, true);
            return;
        }

        state.cart[productId] = currentQtyInCart + quantity;
        saveState(CONFIG.STORAGE_KEYS.CART, state.cart);
        updateCartUI();
    };

    const removeFromCart = (productId) => {
        delete state.cart[productId];
        saveState(CONFIG.STORAGE_KEYS.CART, state.cart);
        updateCartUI();
    };

    const clearCart = () => {
        if (Object.keys(state.cart).length === 0) {
            showToast('Cart is already empty', true);
            return;
        }
        state.cart = {};
        state.appliedCoupon = null;
        saveState(CONFIG.STORAGE_KEYS.CART, state.cart);
        saveState(CONFIG.STORAGE_KEYS.COUPON, state.appliedCoupon);
        updateCartUI();
        showToast('Cart has been cleared');
    };

    const changeQty = (productId, qty) => {
        if (qty <= 0) {
            removeFromCart(productId);
            return;
        }
        const p = getProductById(productId);
        if (qty > p.stock) {
            showToast(`Cannot add more than ${p.stock} items (stock limit).`, true);
            state.cart[productId] = p.stock;
        } else {
            state.cart[productId] = qty;
        }
        saveState(CONFIG.STORAGE_KEYS.CART, state.cart);
        updateCartUI();
    };
    
    const getCartItems = () => {
        return Object.keys(state.cart).map(id => {
            const p = getProductById(id);
            return { ...p, qty: state.cart[id] };
        }).filter(Boolean);
    };
    
    const calculateTotals = () => {
        const items = getCartItems();
        const subtotal = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
        let discount = 0;
        let total = subtotal;

        if (state.appliedCoupon) {
            const coupon = CONFIG.COUPONS[state.appliedCoupon];
            if (coupon) {
                if (coupon.type === 'percent') {
                    discount = subtotal * coupon.value;
                } else if (coupon.type === 'fixed') {
                    discount = coupon.value;
                }
            }
        }
        
        total = Math.max(0, subtotal - discount);
        return { subtotal, discount, total };
    };

    //--------------------- Wishlist Logic ---------------------
    const toggleWishlist = (productId) => {
        const index = state.wishlist.indexOf(productId);
        if (index > -1) {
            state.wishlist.splice(index, 1);
            showToast('Removed from wishlist');
        } else {
            const p = getProductById(productId);
            state.wishlist.push(productId);
            showToast(`Added ${p.title} to wishlist`);
        }
        saveState(CONFIG.STORAGE_KEYS.WISHLIST, state.wishlist);
        updateWishlistUI();
        renderProducts(state.currentPage); // To update heart icon on card
    };
    
    const clearWishlist = () => {
        if (state.wishlist.length === 0) {
            showToast('Wishlist is already empty', true); return;
        }
        state.wishlist = [];
        saveState(CONFIG.STORAGE_KEYS.WISHLIST, state.wishlist);
        updateWishlistUI();
        showToast('Wishlist cleared');
    };
    
    const addAllWishlistToCart = () => {
        if(state.wishlist.length === 0) {
            showToast('Wishlist is empty', true); return;
        }
        let addedCount = 0;
        state.wishlist.forEach(id => {
            addToCart(id, 1);
            addedCount++;
        });
        state.wishlist = [];
        saveState(CONFIG.STORAGE_KEYS.WISHLIST, state.wishlist);
        showToast(`${addedCount} items from wishlist added to cart!`);
        updateWishlistUI();
        openModal($.cartDrawer);
    };

    //--------------------- Recently Viewed Logic ---------------------
    const addToRecentlyViewed = (productId) => {
        state.recentlyViewed = [productId, ...state.recentlyViewed.filter(id => id !== productId)];
        state.recentlyViewed = state.recentlyViewed.slice(0, CONFIG.RECENTLY_VIEWED_COUNT);
        saveState(CONFIG.STORAGE_KEYS.RECENTLY_VIEWED, state.recentlyViewed);
        updateRecentlyViewedUI();
    };
    
    //--------------------- Review Logic ---------------------
    const submitReview = (e) => {
        e.preventDefault();
        const productId = getEl('reviewProductId').value;
        const rating = parseInt(e.target.querySelector('input[name="rating"]:checked')?.value);
        const comment = getEl('reviewComment').value.trim();

        if (!rating) {
            showToast('Please select a star rating.', true); return;
        }

        if (!state.reviews[productId]) {
            state.reviews[productId] = [];
        }
        
        state.reviews[productId].push({ rating, comment, date: new Date().toISOString() });
        saveState(CONFIG.STORAGE_KEYS.REVIEWS, state.reviews);
        showToast('Thank you for your review!');
        closeAllModals();
        renderProducts(state.currentPage); // Re-render to update average rating
    };

    //======================================================================
    // UI UPDATES & POPUPS
    //======================================================================
    const updateCartUI = () => {
        const items = getCartItems();
        if (items.length === 0) {
            $.cartList.innerHTML = '<div class="small" style="padding: 1rem 0;">Your cart is empty.</div>';
            $.cartCount.style.display = 'none';
        } else {
            $.cartCount.textContent = items.reduce((s, i) => s + i.qty, 0);
            $.cartCount.style.display = 'inline-block';
            $.cartList.innerHTML = items.map(i => `
                <div class="cart-line">
                    <img src="${i.img}" alt="${i.title}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/EEE/31343C?text=N/A';">
                    <div class="cart-meta">
                        <div style="font-weight:700">${i.title}</div>
                        <div class="small">${formatCurrency(i.price)} each</div>
                        <div class="qty">
                            <button data-qminus="${i.id}" class="btn secondary" aria-label="Decrease quantity">-</button>
                            <div>${i.qty}</div>
                            <button data-qplus="${i.id}" class="btn secondary" aria-label="Increase quantity" ${i.qty >= i.stock ? 'disabled' : ''}>+</button>
                            <button data-remove="${i.id}" class="btn secondary">Remove</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        const { subtotal, discount, total } = calculateTotals();
        $.subtotal.textContent = formatCurrency(subtotal);
        $.cartTotal.textContent = formatCurrency(total);
        if (discount > 0 && state.appliedCoupon) {
            $.discountLine.innerHTML = `<span>Discount (${state.appliedCoupon})</span> <span>-${formatCurrency(discount)}</span>`;
            $.discountLine.style.display = 'flex';
        } else {
            $.discountLine.style.display = 'none';
        }

        getEl('checkoutBtn').disabled = items.length === 0;
    };

    const updateWishlistUI = () => {
        $.wishlistCount.textContent = state.wishlist.length;
        $.wishlistCount.style.display = state.wishlist.length > 0 ? 'inline-block' : 'none';
        
        if (state.wishlist.length === 0) {
            $.wishlistList.innerHTML = '<div class="small" style="padding: 1rem 0;">Your wishlist is empty.</div>';
        } else {
            $.wishlistList.innerHTML = state.wishlist.map(id => {
                const p = getProductById(id);
                if (!p) return '';
                return `
                    <div class="cart-line">
                        <img src="${p.img}" alt="${p.title}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/EEE/31343C?text=N/A';">
                        <div class="cart-meta">
                            <div style="font-weight:700">${p.title}</div>
                            <div class="small">${formatCurrency(p.price)}</div>
                            <div style="margin-top:0.75rem">
                                <button class="btn" data-add-from-wishlist="${p.id}" ${p.stock === 0 ? 'disabled' : ''}>Add to Cart</button>
                                <button class="btn secondary" data-remove-wishlist="${p.id}">Remove</button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }
    };
    
    const openModal = (modalElement) => {
        closeAllModals(); // Ensure only one modal is open at a time
        modalElement.classList.add('open');
        document.body.style.overflow = 'hidden';
    };

    const closeModal = (modalElement) => {
        modalElement.classList.remove('open');
        if (!document.querySelector('.modal-overlay.open, .drawer.open')) {
             document.body.style.overflow = '';
        }
    };

    const closeAllModals = () => {
        document.querySelectorAll('.modal-overlay, .drawer').forEach(m => closeModal(m));
    };

    const openProductPopup = (product) => {
        addToRecentlyViewed(product.id);
        $.popupImage.src = product.img;
        $.popupTitle.textContent = product.title;
        $.popupDesc.textContent = product.desc;
        $.popupPrice.textContent = formatCurrency(product.price);
        
        const avgRating = getAverageRating(product.id);
        $.popupRating.innerHTML = `${renderStars(avgRating)} (${(state.reviews[product.id] || []).length} reviews)`;
        $.popupRating.title = `Average Rating: ${avgRating.toFixed(1)}/5`;
        
        $.popupAddToCart.dataset.productId = product.id;
        $.popupBuyNow.dataset.productId = product.id;
        $.popupAddToWishlist.dataset.productId = product.id;
        
        $.popupAddToCart.disabled = product.stock === 0;
        $.popupBuyNow.disabled = product.stock === 0;
        $.popupAddToWishlist.className = `btn secondary ${state.wishlist.includes(product.id) ? 'active' : ''}`;
        
        // Render reviews
        const productReviews = state.reviews[product.id] || [];
        if (productReviews.length > 0) {
            $.popupReviewsList.innerHTML = productReviews.map(r => `
                <div class="review">
                    <div class="review-rating">${renderStars(r.rating)}</div>
                    <p class="review-comment">${r.comment || '<i>No comment left.</i>'}</p>
                    <small class="review-author">Reviewed on ${new Date(r.date).toLocaleDateString()}</small>
                </div>
            `).join('');
        } else {
             $.popupReviewsList.innerHTML = `No reviews yet.`;
        }

        openModal($.popup);
    };

    //======================================================================
    // CHECKOUT & ORDER FLOW
    //======================================================================
    const showView = (viewId) => {
        [$.mainShopView, $.checkoutSection, $.orderConfirmation].forEach(v => v.style.display = 'none');
        getEl(viewId).style.display = 'block';
        window.scrollTo(0, 0);
    };

    const openCheckout = () => {
        if (getCartItems().length === 0) {
            showToast('Your cart is empty. Add some products first.', true);
            return;
        }
        closeAllModals();

        const { subtotal, discount, total } = calculateTotals();
        
        $.checkoutSection.innerHTML = `
            <h2 style="margin:0 0 1.5rem">Checkout</h2>
            <div class="row">
                <div class="col">
                    <h3>Shipping Information</h3>
                    <label for="name">Full Name</label>
                    <input id="name" type="text" placeholder="Jane Doe" required>
                    <label for="email">Email for Order Confirmation</label>
                    <input id="email" type="email" placeholder="jane@example.com" required>
                    <label for="address">Shipping Address (Optional for Digital Goods)</label>
                    <input id="address" type="text" placeholder="123 Main St, City, Country">
                </div>
                <div class="col">
                    <h3>Order Summary</h3>
                    <div id="checkoutSummaryList"></div>
                    <div style="display:flex; justify-content: space-between; margin-top: 1rem;"><span>Subtotal:</span> <span>${formatCurrency(subtotal)}</span></div>
                    ${discount > 0 ? `<div style="display:flex; justify-content: space-between; color: var(--success);"><span>Discount:</span> <span>-${formatCurrency(discount)}</span></div>` : ''}
                    <div style="display:flex; justify-content: space-between; font-weight: 700; font-size: 1.2rem; margin-top: 0.5rem;"><span>Total:</span> <span>${formatCurrency(total)}</span></div>
                    
                    <h3 style="margin-top: 2rem;">Payment Method</h3>
                    <div>
                        <label><input type="radio" name="paymethod" value="bank" checked> Bank Transfer</label>
                        <label><input type="radio" name="paymethod" value="paypal"> PayPal</label>
                    </div>
                    <div id="bankDetails" style="margin-top:1.5rem">
                        <p class="small">Bank transfer details â€” send amount to:</p>
                        <div style="background:var(--highlight);padding:1rem;border-radius:0.5rem; color: #333;">
                            <div><strong>Bank:</strong> Example Bank</div>
                            <div><strong>Account Name:</strong> Paper Store Ltd</div>
                            <div><strong>Account Number:</strong> 123-456-789</div>
                        </div>
                        <p class="small" style="margin-top: 1rem;">After payment, click <strong>Place Order</strong> to finalize.</p>
                    </div>
                    <div id="paypalDetails" style="display:none;margin-top:1.5rem">
                        <p class="small">Pay with PayPal. Replace the PayPal CLIENT_ID in the code to enable live buttons.</p>
                        <div id="paypalButtons"></div>
                    </div>
                </div>
            </div>
            <div style="margin-top:1.5rem;display:flex;gap:0.75rem;align-items:center">
                <button class="btn" id="placeBankOrder">Place Order</button>
                <button class="btn secondary" id="backToShop">Back to Shop</button>
            </div>
        `;
        
        getEl('checkoutSummaryList').innerHTML = getCartItems().map(i => `<div class="small">${i.title} (x${i.qty})</div>`).join('');
        
        // Add event listeners for new elements
        getEl('backToShop').addEventListener('click', () => showView('mainShopView'));
        getEl('placeBankOrder').addEventListener('click', placeOrder);
        document.querySelectorAll('input[name=paymethod]').forEach(r => r.addEventListener('change', (e) => {
            const isBank = e.target.value === 'bank';
            getEl('bankDetails').style.display = isBank ? 'block' : 'none';
            getEl('paypalDetails').style.display = !isBank ? 'block' : 'none';
            getEl('placeBankOrder').style.display = isBank ? 'inline-block' : 'none';
        }));

        renderPayPalButtons(total);
        showView('checkoutSection');
    };

    const placeOrder = (details = {}) => {
        const name = getEl('name')?.value.trim();
        const email = getEl('email')?.value.trim();
        if (!name || !email) {
            showToast('Please enter your name and email.', true);
            return false;
        }

        showLoading();
        const orderId = `${details.method === 'paypal' ? 'PP' : 'PS'}-${Date.now()}`;
        const orderItems = getCartItems();
        const { subtotal, discount, total } = calculateTotals();

        const newOrder = { 
            id: orderId, 
            date: new Date().toISOString(),
            items: orderItems,
            total,
            subtotal,
            discount,
            customer: { name, email, address: getEl('address')?.value.trim() },
            ...details 
        };
        
        state.orders.push(newOrder);
        saveState(CONFIG.STORAGE_KEYS.ORDERS, state.orders);

        // Mark items as purchased
        orderItems.forEach(item => {
            if (!state.purchases.includes(item.id)) state.purchases.push(item.id);
            // Deduct stock
            const product = getProductById(item.id);
            if (product) product.stock -= item.qty;
        });
        saveState(CONFIG.STORAGE_KEYS.PURCHASES, state.purchases);
        
        // Clear cart
        state.cart = {};
        state.appliedCoupon = null;
        saveState(CONFIG.STORAGE_KEYS.CART, state.cart);
        saveState(CONFIG.STORAGE_KEYS.COUPON, state.appliedCoupon);

        updateCartUI();
        showOrderConfirmation(newOrder);
        return true;
    };
    
    const showOrderConfirmation = (order) => {
        $.orderConfirmation.innerHTML = `
            <h2 style="margin:0 0 1.5rem">ðŸŽ‰ Order Confirmed!</h2>
            <p>Thank you for your purchase, ${order.customer.name}! Your order ID is: <strong>${order.id}</strong></p>
            <p class="small">A confirmation has been sent to ${order.customer.email}. Your downloads are available below.</p>
            <h3 style="margin:2rem 0 1rem">Your Items</h3>
            <div id="downloadList">
                ${order.items.map(i => `
                    <div class="cart-line">
                        <img src="${i.img}" alt="${i.title}">
                        <div class="cart-meta">
                            <div style="font-weight:700">${i.title}</div>
                            <div class="small">Qty: ${i.qty}</div>
                            <div style="margin-top:0.75rem; display: flex; gap: 0.5rem;">
                                <button class="btn secondary" data-download="${i.id}">Download</button>
                                <button class="btn secondary" data-review="${i.id}">Leave Review</button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            <button class="btn" id="backToShopFromConfirm" style="margin-top:1.5rem">Continue Shopping</button>
        `;

        getEl('backToShopFromConfirm').addEventListener('click', () => showView('mainShopView'));
        getEl('downloadList').addEventListener('click', e => {
            const downloadBtn = e.target.closest('[data-download]');
            const reviewBtn = e.target.closest('[data-review]');
            if (downloadBtn) {
                downloadFile(downloadBtn.dataset.download);
            }
            if (reviewBtn) {
                getEl('reviewProductId').value = reviewBtn.dataset.review;
                $.reviewForm.reset();
                openModal($.reviewModal);
            }
        });

        showView('orderConfirmation');
        renderProducts(); // Re-render to show updated stock / download buttons
    };
    
    const downloadFile = (productId) => {
        if (!state.purchases.includes(productId)) {
            showToast('Please purchase the product to download.', true);
            return;
        }
        const product = getProductById(productId);
        showToast(`Preparing download for ${product.title}...`);
        setTimeout(() => {
            console.log(`Simulating download from: ${product.downloadLink}`);
            window.open(product.downloadLink, '_blank');
            showToast('Download started.');
        }, 1000);
    };

    const renderPayPalButtons = (total) => {
        const container = getEl('paypalButtons');
        if (!container) return;
        if (typeof paypal === 'undefined' || !paypal.Buttons) {
            container.innerHTML = `<p class="small" style="color: var(--error);">PayPal is currently unavailable. Please replace the CLIENT_ID in the code.</p>`;
            return;
        }
        container.innerHTML = ''; // Clear previous buttons
        paypal.Buttons({
            style: { layout: 'vertical', color: 'blue', shape: 'rect', label: 'paypal' },
            createOrder: (data, actions) => {
                if (total <= 0) {
                    showToast('Cannot process $0 order with PayPal.', true);
                    return Promise.reject(new Error('Amount is zero'));
                }
                return actions.order.create({ purchase_units: [{ amount: { value: total.toFixed(2) } }] });
            },
            onApprove: (data, actions) => {
                return actions.order.capture().then(details => {
                    placeOrder({ method: 'paypal', paymentDetails: details });
                });
            },
            onError: (err) => {
                console.error('PayPal error:', err);
                showToast('A PayPal error occurred. Please try again or use another method.', true);
            }
        }).render('#paypalButtons').catch(err => {
            console.error('PayPal render error:', err);
            container.innerHTML = `<p class="small" style="color: var(--error);">Could not render PayPal buttons.</p>`;
        });
    };

    //======================================================================
    // THEME & MISC UI
    //======================================================================
    const applyTheme = (theme) => {
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            getEl('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            document.body.classList.remove('dark-mode');
            getEl('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
        }
    };
    
    const showOrderHistory = () => {
        const listEl = getEl('orderHistoryList');
        if (state.orders.length === 0) {
            listEl.innerHTML = '<p>You have no past orders.</p>';
        } else {
            listEl.innerHTML = state.orders.slice().reverse().map(order => `
                <div class="order-item">
                    <div class="order-header">
                        <div>
                            <strong>Order ID:</strong> ${order.id}<br>
                            <small><strong>Date:</strong> ${new Date(order.date).toLocaleString()}</small>
                        </div>
                        <div>
                            <strong>Total: ${formatCurrency(order.total)}</strong>
                        </div>
                    </div>
                    ${order.items.map(item => `
                        <div class="cart-line">
                            <img src="${item.img}" alt="${item.title}">
                            <div>${item.title} (x${item.qty})</div>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }
        openModal($.orderHistoryModal);
    };

    //======================================================================
    // EVENT LISTENERS
    //======================================================================
    
    // Header & Global Controls
    getEl('themeToggle').addEventListener('click', () => {
        const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
        localStorage.setItem(CONFIG.STORAGE_KEYS.THEME, newTheme);
        applyTheme(newTheme);
    });
    
    getEl('shopNow').addEventListener('click', () => {
        getEl('productGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    
    getEl('openOrders').addEventListener('click', showOrderHistory);
    getEl('openCart').addEventListener('click', () => openModal($.cartDrawer));
    getEl('openWishlist').addEventListener('click', () => openModal($.wishlistDrawer));

    // Modals and Drawers Closing Logic
    document.addEventListener('click', (e) => {
        // Close via close button
        const closeBtn = e.target.closest('.close-btn, .close-drawer-btn');
        if (closeBtn) {
            const modal = e.target.closest('.modal-overlay, .drawer');
            if (modal) closeModal(modal);
            return;
        }

        // Close by clicking overlay
        if (e.target.classList.contains('modal-overlay')) {
            closeModal(e.target);
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === "Escape") closeAllModals();
    });

    // Product Grid Interactions
    $.productGrid.addEventListener('click', e => {
        const buyBtn = e.target.closest('[data-buy]');
        const wishlistBtn = e.target.closest('[data-wishlist]');
        const downloadBtn = e.target.closest('[data-download]');
        const quickViewBtn = e.target.closest('[data-quick-view]');
        const card = e.target.closest('.card');
        
        if (buyBtn) {
            e.stopPropagation();
            addToCart(buyBtn.dataset.buy, 1);
            showToast('Added to cart!');
            openModal($.cartDrawer);
        } else if (wishlistBtn) {
            e.stopPropagation();
            toggleWishlist(wishlistBtn.dataset.wishlist);
        } else if (downloadBtn) {
            e.stopPropagation();
            downloadFile(downloadBtn.dataset.download);
        } else if (quickViewBtn) {
            e.stopPropagation();
            const p = getProductById(quickViewBtn.dataset.quickView);
            if (p) openProductPopup(p);
        } else if (card) {
            const p = getProductById(card.dataset.productId);
            if (p) openProductPopup(p);
        }
    });
    
    // Product Popup Buttons
    $.popupAddToCart.addEventListener('click', (e) => {
        addToCart(e.currentTarget.dataset.productId, 1);
        showToast('Added to cart');
        closeModal($.popup);
    });
    $.popupBuyNow.addEventListener('click', (e) => {
        addToCart(e.currentTarget.dataset.productId, 1);
        closeModal($.popup);
        openCheckout();
    });
    $.popupAddToWishlist.addEventListener('click', (e) => {
        toggleWishlist(e.currentTarget.dataset.productId);
        e.currentTarget.classList.toggle('active');
    });

    // Filtering and Sorting
    getEl('categoryFilter').addEventListener('change', e => {
        state.currentCategory = e.target.value;
        renderProducts(0);
    });
    getEl('sortFilter').addEventListener('change', e => {
        state.sortOption = e.target.value;
        renderProducts(0);
    });
    
    // Pagination
    $.prevPageBtn.addEventListener('click', () => {
        if (state.currentPage > 0) renderProducts(state.currentPage - 1);
    });
    $.nextPageBtn.addEventListener('click', () => {
        renderProducts(state.currentPage + 1);
    });

    // Cart Interactions
    $.cartList.addEventListener('click', e => {
        const plus = e.target.closest('[data-qplus]');
        const minus = e.target.closest('[data-qminus]');
        const remove = e.target.closest('[data-remove]');
        if (plus) changeQty(plus.dataset.qplus, (state.cart[plus.dataset.qplus] || 0) + 1);
        if (minus) changeQty(minus.dataset.qminus, (state.cart[minus.dataset.qminus] || 0) - 1);
        if (remove) removeFromCart(remove.dataset.remove);
    });
    getEl('clearCart').addEventListener('click', clearCart);
    getEl('checkoutBtn').addEventListener('click', openCheckout);
    $.applyCouponBtn.addEventListener('click', () => {
        const code = $.couponInput.value.trim().toUpperCase();
        if (CONFIG.COUPONS[code]) {
            state.appliedCoupon = code;
            saveState(CONFIG.STORAGE_KEYS.COUPON, state.appliedCoupon);
            showToast(`Coupon "${code}" applied!`);
            updateCartUI();
        } else {
            showToast('Invalid coupon code.', true);
        }
    });

    // Wishlist Interactions
    getEl('clearWishlist').addEventListener('click', clearWishlist);
    getEl('wishlistAddAllToCart').addEventListener('click', addAllWishlistToCart);
    $.wishlistList.addEventListener('click', e => {
        const addBtn = e.target.closest('[data-add-from-wishlist]');
        const removeBtn = e.target.closest('[data-remove-wishlist]');
        if (addBtn) {
            addToCart(addBtn.dataset.addFromWishlist, 1);
            toggleWishlist(addBtn.dataset.addFromWishlist); // Remove from wishlist after adding
            showToast('Added to cart');
        }
        if (removeBtn) {
            toggleWishlist(removeBtn.dataset.removeWishlist);
        }
    });
    
    // Search with Suggestions
    $.searchInput.addEventListener('input', () => {
        const query = $.searchInput.value.toLowerCase();
        state.searchQuery = query;
        renderProducts(0); // Live search filtering
        
        if (query.length < 2) {
            $.searchSuggestions.style.display = 'none';
            return;
        }
        const matched = state.products.filter(p => p.title.toLowerCase().includes(query)).slice(0, 5);
        if (matched.length > 0) {
            $.searchSuggestions.innerHTML = matched.map(p => `
                <div class="suggestion-item" data-product-id="${p.id}">
                    <img src="${p.img}" alt="">
                    <span class="title">${p.title}</span>
                    <span class="price">${formatCurrency(p.price)}</span>
                </div>`).join('');
            $.searchSuggestions.style.display = 'block';
        } else {
            $.searchSuggestions.style.display = 'none';
        }
    });
    
    $.searchSuggestions.addEventListener('click', e => {
        const item = e.target.closest('.suggestion-item');
        if (item) {
            const product = getProductById(item.dataset.productId);
            if (product) openProductPopup(product);
            $.searchSuggestions.style.display = 'none';
        }
    });

    // Back to Top Button
    window.addEventListener('scroll', () => {
        $.backToTopBtn.classList.toggle('show', window.scrollY > 300);
    });
    $.backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

    // Review Form
    $.reviewForm.addEventListener('submit', submitReview);

    //======================================================================
    // INITIALIZATION
    //======================================================================
    const init = () => {
        loadState();
        applyTheme(localStorage.getItem(CONFIG.STORAGE_KEYS.THEME) || 'light');
        renderProducts(0);
        updateCartUI();
        updateWishlistUI();
        updateRecentlyViewedUI();
    };

    init();
});
</script>
</body>
</html>